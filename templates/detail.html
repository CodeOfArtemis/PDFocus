{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="detail-header">
        <h2>{{ pdf.title }}</h2>
    </div>

    <form method="post" class="pdf-meta-form" id="pdf-meta-form">
        {% csrf_token %}
        <div class="form-group">
            <label><strong>–ê–≤—Ç–æ—Ä:</strong></label>
            <input type="text" name="authors" value="{{ pdf.authors }}" class="editable-field">
        </div>

        <div class="form-group">
            <label><strong>–¢–∏–ø:</strong></label>
            <select name="doc_type" class="editable-field">
                <option value="–ö–Ω–∏–≥–∞" {% if pdf.doc_type == "–ö–Ω–∏–≥–∞" %}selected{% endif %}>–ö–Ω–∏–≥–∞</option>
                <option value="–°—Ç–∞—Ç—å—è" {% if pdf.doc_type == "–°—Ç–∞—Ç—å—è" %}selected{% endif %}>–°—Ç–∞—Ç—å—è</option>
                <option value="–û—Ç—á–µ—Ç" {% if pdf.doc_type == "–û—Ç—á–µ—Ç" %}selected{% endif %}>–û—Ç—á–µ—Ç</option>
                <option value="–î—Ä—É–≥–æ–µ" {% if pdf.doc_type == "–î—Ä—É–≥–æ–µ" %}selected{% endif %}>–î—Ä—É–≥–æ–µ</option>
            </select>
        </div>

        <div class="form-group">
            <label><strong>–¢–µ–º–∞:</strong></label>
            <input type="text" name="theme" value="{{ pdf.theme }}" class="editable-field">
        </div>

        <div class="form-group">
            <label><strong>–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:</strong></label>
            <input type="text" name="keywords" value="{{ pdf.keywords }}" class="editable-field">
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            <a href="{{ pdf.file.url }}" class="btn btn-primary" download>–°–∫–∞—á–∞—Ç—å PDF</a>
            <button type="button" class="btn btn-primary" id="publish-btn" data-document-id="{{ pdf.id }}" data-is-published="{{ pdf.is_published|yesno:'true,false' }}">
                {% if pdf.is_published %}–°–∫—Ä—ã—Ç—å{% else %}–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å{% endif %}
            </button>
        </div>
    </form>

    <div class="pdf-view-container">
        <div class="pdf-viewer-section">
            <h3>–ü—Ä–æ—Å–º–æ—Ç—Ä PDF:</h3>
            <div class="pdf-viewer-wrapper">
                <div class="pdf-placeholder" id="pdf-placeholder-detail">
                    <i>üìÑ</i>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ PDF...</p>
                </div>
                <div id="pdf-viewer-detail"></div>
            </div>
        </div>

        <div class="extracted-text-section">
            <h3>–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:</h3>
            <textarea readonly style="width: 100%; height: 500px">{{ pdf.extracted_text }}</textarea>
        </div>
    </div>

    <div class="pdf-controls-detail" id="pdf-controls-detail">
        <div class="pdf-nav-buttons">
            <button id="prev-page-detail" class="btn btn-secondary">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
            <span id="page-num-detail">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 –∏–∑ 1</span>
            <button id="next-page-detail" class="btn btn-secondary">–°–ª–µ–¥—É—é—â–∞—è</button>
        </div>
    </div>

    <div class="notes-section">
        <h3>–ó–∞–º–µ—Ç–∫–∏</h3>
        <form method="post" class="note-form" id="note-form-detail">
            {% csrf_token %}
            <input type="hidden" name="document_id" value="{{ pdf.id }}">
            <input type="hidden" id="pdf-file-url" value="{{ pdf.file.url }}">
            <input type="hidden" name="page_number" id="current_page_number" value="1">
            <div class="form-group">
                <label for="id_note_text">–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏:</label>
                <textarea name="text" id="id_note_text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏..." required class="note-textarea"></textarea>
            </div>
            <div class="note-form-footer">
                <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
            </div>
        </form>

        <div class="notes-list">
            {% for note in notes %}
            <div class="note-item" data-note-id="{{ note.id }}">
                <div class="note-content">
                    <p class="note-text">{{ note.text }}</p>
                    <span class="note-meta">–°—Ç—Ä. {{ note.page_number }} - {{ note.created_at|date:"d.m.Y H:i" }}</span>
                </div>
                <button class="note-delete-btn" data-note-id="{{ note.id }}" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É">‚úï</button>
            </div>
            {% empty %}
            <p>–ö —ç—Ç–æ–º—É –¥–æ–∫—É–º–µ–Ω—Ç—É –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–º–µ—Ç–æ–∫.</p>
            {% endfor %}
        </div>
    </div>
</div>

{{ page_texts|json_script:"page-texts-data" }}
<script>
// –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç–µ–∫—Å—Ç–µ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º –≤ JavaScript
const pageTextsElement = document.getElementById('page-texts-data');
window.pageTexts = pageTextsElement ? JSON.parse(pageTextsElement.textContent) : {};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
function initPublishButton() {
    const publishBtn = document.getElementById('publish-btn');
    if (publishBtn) {
        publishBtn.addEventListener('click', function() {
            const documentId = this.dataset.documentId;
            const isPublished = this.dataset.isPublished === 'true';
            
            fetch(`/publish/${documentId}/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
                    this.dataset.isPublished = data.is_published;
                    this.textContent = data.is_published ? '–°–∫—Ä—ã—Ç—å' : '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å';
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showNotification(data.message, 'success');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏', 'error');
            });
        });
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', initPublishButton);
</script>
{% endblock %}